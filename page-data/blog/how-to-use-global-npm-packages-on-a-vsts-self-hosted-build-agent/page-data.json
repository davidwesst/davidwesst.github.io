{"componentChunkName":"component---src-templates-post-template-js","path":"/blog/how-to-use-global-npm-packages-on-a-vsts-self-hosted-build-agent/","result":{"data":{"markdownRemark":{"excerpt":"I took a couple of weeks off of blogging to focus on a building my presentation for Deliver. In my spare time, I started tinkering with Visual Studio Team…","html":"<p>I took a couple of weeks off of blogging to focus on a building my presentation for <a href=\"http://www.prdcdeliver.com/\">Deliver</a>. In my spare time, I started tinkering with Visual Studio Team Services, where decided to start by automating the build and release of this blog.</p>\n<p>My build script is pretty straight forward. Setup the global dependencies with NPM, setup the local dependencies with NPM, generate the content, and publish the generated assets. This worked in my hosted agent, but not my self-hosted agent.</p>\n<p>I found a few solutions, but I’ll go through the one I selected for my build agent.</p>\n<h3>The Problem</h3>\n<p>My build script would run <code class=\"language-text\">npm install --global hexo-cli</code> and execute as expected. When the next step would try and use the <code class=\"language-text\">hexo generate</code> command, I would get the following error:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">##[error]hexo : The term &#39;hexo&#39; is not recognized as the name of a cmdlet, function, script file, or operable program. Check \nthe spelling of the name, or if a path was included, verify that the path is correct and try again.</code></pre></div>\n<p>Even though the install command was successful, the build script still couldn’t use the tool installed.</p>\n<p>Another symptom of this problem is that Team Services can’t see global NPM packages as common capabilities, such as Bower, Gulp, and Grunt.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 614px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ac339e0c66d4f1e43f0b80f1544efe3b/e9131/pkLEzkEl.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.68354430379747%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAABwgAAAcIAHND5ueAAAAiUlEQVQY033PwQ6EIAwEUP//K/cIlBbGAqsLwkaNyXpw36lJM510KqWUnPPSXvz26TPG6ONR77flBCDGiDm5oHFO67r0HzlnAPNFVXE450lEaq3n3TH6dgeAiJhZROjivScia+3e3FrbHqiqiISDXACklPbmEMKfcIzRGENEzjlrrTGGmVX1/P8L5Qsgz/b+askAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"&quot;Gulp and Grunt as capabilities&quot;\"\n        title=\"&quot;Gulp and Grunt as capabilities&quot;\"\n        src=\"/static/ac339e0c66d4f1e43f0b80f1544efe3b/e9131/pkLEzkEl.png\"\n        srcset=\"/static/ac339e0c66d4f1e43f0b80f1544efe3b/c26ae/pkLEzkEl.png 158w,\n/static/ac339e0c66d4f1e43f0b80f1544efe3b/6bdcf/pkLEzkEl.png 315w,\n/static/ac339e0c66d4f1e43f0b80f1544efe3b/e9131/pkLEzkEl.png 614w\"\n        sizes=\"(max-width: 614px) 100vw, 614px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>I setup my build agent to use the NetworkService user account, but it could be setup for any user. The problem is that the NetworkService account can’t see the global packages on the machine after they are installed. The solution is to configure NPM to point to a folder that is visible to the NetworkService account.</p>\n<p>Here’s how you do it.</p>\n<h3>The Solution</h3>\n<p>I found <a href=\"http://stackoverflow.com/questions/38570209/making-global-npm-packages-available-to-all-users-on-windows-2012-server\">this solution on StackOverflow</a> which lead me in the right direction, although I didn’t follow all of it.</p>\n<p>The <a href=\"https://docs.npmjs.com/cli/prefix\"><code class=\"language-text\">npm prefix -g</code></a> command shows us path to global prefix folder, where the global npm packages are stored. We need to point this to a directory that NetworkService can read and execute. Generally speaking, the prefix folder is usually found in the user’s AppData folder.</p>\n<p>To change the prefix, run the command <code class=\"language-text\">npm config set prefix C:\\\\Path\\\\To\\\\Folder\\\\AppData\\\\Roaming\\\\npm</code> which will change the npm prefix folder to be the one specified. Because I’ve set my build agent NetworkService account, I point it at the NetworkService account AppData npm folder for simplicity.</p>\n<p>Then add the folder to the PATH variable for the machine. This will let VSTS see the npm packages as capabilities so that it knows that our build server can execute Grunt, Gulp, and Bower tasks.</p>\n<h4>Why Didn’t You Reset the Prefix?</h4>\n<p>It makes sense to reset the prefix to the previous value after the build has complete, as described in the StackOverflow solution. In my case, I wanted to make sure that if someone were logging into the build server to add another global package, let’s say something like Hexo CLI, then it would be installed in the appropriate directory.</p>\n<p>I didn’t reset the prefix because I wanted to permanently configure the build agent. It’s a small build server that I’m using to experiment with continuous integration and deployment. If it’s good enough for StackOverflow then it’s good enough for me.</p>\n<h2>A Few Alternative Solutions</h2>\n<p>As an alternative solution you could setup a new directory that isn’t the AppData folder, add the new folder to the PATH, and then point the prefix folder at build time. You could also leverage the <code class=\"language-text\">npm bin</code> setting and setup alias in your package.json file for the global commands you’re looking to use (Thanks to <a href=\"http://www.aaron-powell.com/\">Aaron Powell</a> for providing me with that one), which is another good solution that I’ll revisit if I use something other than VSTS for builds.</p>","frontmatter":{"title":"How to Use Global NPM Packages on a VSTS Self-Hosted Build Agent","tags":["javascript","visual studio team services","nodejs","npm"],"categories":["development"],"date":"October 24, 2016","description":null,"social_image":null}},"prev":{"frontmatter":{"title":"How to Blog with VSTS (Part 1)"},"fields":{"slug":"/blog/how-to-blog-with-vsts-part-1/"}},"next":{"frontmatter":{"title":"Windows Not Required - The New Microsoft Development Story (Video)"},"fields":{"slug":"/blog/windows-not-required-video/"}}},"pageContext":{"slug":"/blog/how-to-use-global-npm-packages-on-a-vsts-self-hosted-build-agent/","prevSlug":"/blog/how-to-blog-with-vsts-part-1/","nextSlug":"/blog/windows-not-required-video/"}},"staticQueryHashes":["2555585279","2841359383","3159585216"]}